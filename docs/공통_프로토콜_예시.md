```typescript
// ================================
// 업데이트된 Boxwood-External 통신 프로토콜 v2.0
// ================================

/**
 * JWT 인증 정보
 */
interface AuthenticationInfo {
    accessToken: string;           // JWT Access Token
    tokenType: 'Bearer';
    expiresAt: number;            // Unix timestamp
    permissions: string[];         // 권한 목록
    sessionId: string;            // 세션 ID
}

/**
 * Form Schema 정의 (External에서 필요한 변수 구조 정의)
 */
interface FormSchemaDefinition {
    formType: 'user' | 'order' | 'settings' | 'invoice' | 'custom';
    schemaVersion: string;        // 스키마 버전 (호환성 관리)
    requiredVariables: {
        [key: string]: {
            type: 'string' | 'number' | 'boolean' | 'object' | 'array';
            required: boolean;
            validation?: {
                minLength?: number;
                maxLength?: number;
                pattern?: string;
                min?: number;
                max?: number;
            };
            description?: string;
        }
    };
    optionalVariables?: {
        [key: string]: {
            type: 'string' | 'number' | 'boolean' | 'object' | 'array';
            defaultValue?: any;
            description?: string;
        }
    };
    formConfig: {
        title: string;
        readonly: boolean;
        layout?: 'vertical' | 'horizontal' | 'grid';
        theme?: 'light' | 'dark' | 'auto';
        language: 'ko' | 'en';
    };
}

/**
 * Boxwood → External 요청 데이터 구조 (Updated)
 */
interface ExternalFormRequestDto {
    // 기본 정보
    requestId: string;            // 요청 추적을 위한 고유 ID
    timestamp: number;            // 요청 시간

    // 인증 정보
    authentication: AuthenticationInfo;

    // Form 정보
    formSchema: FormSchemaDefinition;

    // 실제 변수 데이터 (스키마에 따라 매핑될 데이터)
    variableData: Map<string, any>;

    // 클라이언트 정보
    clientInfo: {
        userAgent: string;
        viewport: {
            width: number;
            height: number;
        };
        timezone: string;
        locale: string;
    };

    // 콜백 설정
    callbacks: {
        onReady: boolean;
        onDestroy: boolean;
        onSubmit: boolean;
        onChange: boolean;
        onError: boolean;
        onResize: boolean;
        heartbeat: boolean;          // 하트비트 사용 여부
    };

    // 연결 설정
    connectionConfig: {
        heartbeatInterval: number;    // 하트비트 간격 (ms)
        reconnectAttempts: number;    // 재연결 시도 횟수
        timeout: number;              // 요청 타임아웃 (ms)
    };
}

/**
 * External → Boxwood 응답 데이터 구조 (Updated)
 */
interface ExternalFormResponseDto {
    // 기본 응답 정보
    requestId: string;            // 원본 요청 ID
    success: boolean;
    timestamp: number;

    // Form 정보
    formInfo?: {
        formId: string;             // External에서 생성한 고유 Form ID
        formUrl: string;            // iframe에서 로드할 URL
        expectedHeight: number;     // 예상 Form 높이
        formVersion: string;        // Form 버전
    };

    // 매핑된 변수 정보
    mappedVariables?: {
        [key: string]: {
            mapped: boolean;          // 매핑 성공 여부
            fieldName: string;        // 실제 Form 필드명
            value: any;              // 매핑된 값
            error?: string;          // 매핑 실패 시 오류 메시지
        }
    };

    // 스키마 검증 결과
    schemaValidation: {
        isValid: boolean;
        missingRequired: string[];   // 누락된 필수 변수들
        invalidTypes: {             // 타입이 맞지 않는 변수들
            [key: string]: {
                expected: string;
                actual: string;
            }
        };
        warnings: string[];         // 경고 메시지들
    };

    // 오류 정보
    error?: {
        code: string;
        message: string;
        details?: any;
    };
}

/**
 * PostMessage 이벤트 타입 (확장됨)
 */
type PostMessageEventType =
// 생명주기 이벤트
    | 'FORM_READY'              // Form 완전 로딩 완료
    | 'FORM_MOUNTED'            // Form 컴포넌트 마운트
    | 'FORM_UNMOUNTED'          // Form 컴포넌트 언마운트  
    | 'FORM_DESTROY'            // Form 정리

    // 데이터 이벤트
    | 'FORM_SUBMIT'             // Form 제출
    | 'FORM_CHANGE'             // Form 데이터 변경
    | 'FORM_VALIDATE'           // Form 검증
    | 'FORM_RESET'              // Form 초기화

    // UI 이벤트
    | 'FORM_RESIZE'             // Form 크기 변경
    | 'FORM_FOCUS'              // Form 포커스
    | 'FORM_BLUR'               // Form 포커스 해제

    // 연결 관리 이벤트
    | 'HEARTBEAT_PING'          // 하트비트 핑
    | 'HEARTBEAT_PONG'          // 하트비트 퐁
    | 'CONNECTION_LOST'         // 연결 끊김
    | 'CONNECTION_RESTORED'     // 연결 복원

    // 오류 이벤트
    | 'FORM_ERROR'              // Form 오류
    | 'VALIDATION_ERROR'        // 검증 오류
    | 'NETWORK_ERROR'           // 네트워크 오류
    | 'AUTH_ERROR'              // 인증 오류

    // 명령 이벤트
    | 'BOXWOOD_COMMAND'         // Boxwood → External 명령
    | 'EXTERNAL_RESPONSE'       // External → Boxwood 응답
    | 'UPDATE_VARIABLES'        // 변수 업데이트
    | 'REFRESH_TOKEN';          // 토큰 갱신

/**
 * PostMessage 데이터 구조 (Updated)
 */
interface PostMessageData {
    // 기본 정보
    type: PostMessageEventType;
    source: 'boxwood' | 'external';
    timestamp: number;
    messageId: string;           // 메시지 추적을 위한 고유 ID

    // 세션 정보
    sessionId: string;
    formId?: string;
    requestId?: string;

    // 페이로드
    data: any;

    // 메타데이터
    metadata?: {
        version: string;           // 프로토콜 버전
        priority: 'high' | 'normal' | 'low';
        requiresResponse: boolean;  // 응답이 필요한 메시지인지
        correlationId?: string;    // 요청-응답 연결을 위한 ID
    };

    // 오류 정보
    error?: {
        code: string;
        message: string;
        stack?: string;
    };
}

/**
 * 생명주기 이벤트 데이터 (Enhanced)
 */
interface LifecycleEventData {
    event: 'onReady' | 'onDestroy' | 'onMount' | 'onUnmount' | 'onError';
    formId: string;
    timestamp: number;

    // Form 상태 정보
    formState?: {
        isValid: boolean;
        isDirty: boolean;           // 변경사항 있는지
        fieldCount: number;
        validationErrors: Record<string, string>;
    };

    // 성능 정보
    performance?: {
        loadTime: number;           // 로딩 시간 (ms)
        renderTime: number;         // 렌더링 시간 (ms)
        memoryUsage?: number;       // 메모리 사용량 (MB)
    };

    // Form 메타데이터
    metadata?: {
        variables: string[];        // 사용된 변수 목록
        components: string[];       // 사용된 컴포넌트 목록
        dependencies: string[];     // 의존성 목록
    };

    // 에러 정보 (onError인 경우)
    error?: {
        type: 'validation' | 'network' | 'auth' | 'runtime' | 'unknown';
        code: string;
        message: string;
        context?: any;
    };
}

/**
 * Form 변경 이벤트 데이터 (Enhanced)
 */
interface FormChangeEventData {
    changedFields: {
        fieldName: string;
        variableName: string;       // 매핑된 변수명
        oldValue: any;
        newValue: any;
        isValid: boolean;
        validationMessage?: string;
        changeType: 'user' | 'programmatic' | 'external';
    }[];

    formData: Record<string, any>;

    // 검증 결과
    validation: {
        isFormValid: boolean;
        fieldValidations: Record<string, {
            isValid: boolean;
            errors: string[];
            warnings: string[];
        }>;
    };

    // 변경 통계
    changeStats: {
        totalChanges: number;
        changedFieldsCount: number;
        invalidFieldsCount: number;
        lastChangeTime: number;
    };
}

/**
 * 하트비트 데이터
 */
interface HeartbeatData {
    type: 'ping' | 'pong';
    timestamp: number;
    sequenceNumber: number;

    // 연결 상태 정보
    connectionInfo: {
        latency?: number;           // 지연 시간 (ms)
        packetsLost: number;        // 손실된 패킷 수
        reconnectCount: number;     // 재연결 횟수
    };

    // 클라이언트 상태
    clientStatus: {
        isVisible: boolean;         // 탭이 활성화되어 있는지
        memoryUsage?: number;       // 메모리 사용량
        cpuUsage?: number;          // CPU 사용량 (가능한 경우)
    };
}

/**
 * 오류 처리를 위한 에러 코드 정의
 */
enum ErrorCode {
    // 인증 관련
    AUTH_TOKEN_EXPIRED = 'AUTH_TOKEN_EXPIRED',
    AUTH_TOKEN_INVALID = 'AUTH_TOKEN_INVALID',
    AUTH_PERMISSION_DENIED = 'AUTH_PERMISSION_DENIED',

    // 스키마 관련
    SCHEMA_VERSION_MISMATCH = 'SCHEMA_VERSION_MISMATCH',
    SCHEMA_VALIDATION_FAILED = 'SCHEMA_VALIDATION_FAILED',
    VARIABLE_MAPPING_FAILED = 'VARIABLE_MAPPING_FAILED',
    REQUIRED_VARIABLE_MISSING = 'REQUIRED_VARIABLE_MISSING',

    // 연결 관련
    CONNECTION_TIMEOUT = 'CONNECTION_TIMEOUT',
    CONNECTION_LOST = 'CONNECTION_LOST',
    HEARTBEAT_TIMEOUT = 'HEARTBEAT_TIMEOUT',
    IFRAME_LOAD_FAILED = 'IFRAME_LOAD_FAILED',

    // Form 관련
    FORM_LOAD_FAILED = 'FORM_LOAD_FAILED',
    FORM_RENDER_FAILED = 'FORM_RENDER_FAILED',
    FORM_VALIDATION_FAILED = 'FORM_VALIDATION_FAILED',
    FORM_SUBMIT_FAILED = 'FORM_SUBMIT_FAILED',

    // 네트워크 관련
    NETWORK_ERROR = 'NETWORK_ERROR',
    REQUEST_TIMEOUT = 'REQUEST_TIMEOUT',
    SERVER_ERROR = 'SERVER_ERROR'
}

// ================================
// 실제 구현 예시 (Updated)
// ================================

/**
 * Boxwood → External Form 요청 예시 (JWT 포함)
 */
const exampleFormRequest: ExternalFormRequestDto = {
    requestId: 'req_' + Date.now(),
    timestamp: Date.now(),

    authentication: {
        accessToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
        tokenType: 'Bearer',
        expiresAt: Date.now() + 3600000, // 1시간 후
        permissions: ['form:read', 'form:write', 'user:update'],
        sessionId: 'session_abc123'
    },

    formSchema: {
        formType: 'user',
        schemaVersion: '2.1.0',
        requiredVariables: {
            'user.name': {
                type: 'string',
                required: true,
                validation: {minLength: 2, maxLength: 50},
                description: '사용자 이름'
            },
            'user.email': {
                type: 'string',
                required: true,
                validation: {pattern: '^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$'},
                description: '사용자 이메일'
            }
        },
        optionalVariables: {
            'user.avatar': {
                type: 'string',
                defaultValue: '/images/default-avatar.png',
                description: '프로필 이미지 URL'
            }
        },
        formConfig: {
            title: '사용자 정보 수정',
            readonly: false,
            layout: 'vertical',
            theme: 'light',
            language: 'ko'
        }
    },

    variableData: new Map([
        ['user.name', '김개발자'],
        ['user.email', 'developer@boxwood.com'],
        ['user.avatar', '/images/avatar-dev.jpg'],
        ['company.name', 'Boxwood Technology']
    ]),

    clientInfo: {
        userAgent: navigator.userAgent,
        viewport: {width: 1920, height: 1080},
        timezone: 'Asia/Seoul',
        locale: 'ko-KR'
    },

    callbacks: {
        onReady: true,
        onDestroy: true,
        onSubmit: true,
        onChange: true,
        onError: true,
        onResize: true,
        heartbeat: true
    },

    connectionConfig: {
        heartbeatInterval: 30000,    // 30초
        reconnectAttempts: 3,
        timeout: 10000               // 10초
    }
};

/**
 * External → Boxwood Form 응답 예시 (향상된 검증 포함)
 */
const exampleFormResponse: ExternalFormResponseDto = {
    requestId: 'req_' + Date.now(),
    success: true,
    timestamp: Date.now(),

    formInfo: {
        formId: 'form_user_' + Date.now(),
        formUrl: 'https://external.boxwood.com/forms/user/edit?token=...',
        expectedHeight: 650,
        formVersion: '2.1.0'
    },

    mappedVariables: {
        'user.name': {
            mapped: true,
            fieldName: 'userName',
            value: '김개발자'
        },
        'user.email': {
            mapped: true,
            fieldName: 'userEmail',
            value: 'developer@boxwood.com'
        },
        'user.avatar': {
            mapped: true,
            fieldName: 'avatarUrl',
            value: '/images/avatar-dev.jpg'
        }
    },

    schemaValidation: {
        isValid: true,
        missingRequired: [],
        invalidTypes: {},
        warnings: ['user.phone 변수가 제공되지 않았지만 선택사항입니다.']
    }
};

/**
 * PostMessage 이벤트 예시 (하트비트 포함)
 */
const exampleHeartbeatMessage: PostMessageData = {
    type: 'HEARTBEAT_PING',
    source: 'boxwood',
    timestamp: Date.now(),
    messageId: 'msg_' + Date.now(),
    sessionId: 'session_abc123',

    data: {
        type: 'ping',
        timestamp: Date.now(),
        sequenceNumber: 42,
        connectionInfo: {
            packetsLost: 0,
            reconnectCount: 0
        },
        clientStatus: {
            isVisible: true,
            memoryUsage: 125.5
        }
    } as HeartbeatData,

    metadata: {
        version: '2.0',
        priority: 'normal',
        requiresResponse: true,
        correlationId: 'ping_42'
    }
};
```