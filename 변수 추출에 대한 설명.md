# FreeMarker Mock Environment ë³€ìˆ˜ ì¶”ì¶œ ê°€ì´ë“œ

## ğŸš€ ê°œìš”

ì´ ë¬¸ì„œëŠ” FreeMarker í…œí”Œë¦¿ì—ì„œ **Mock Environment** ë°©ì‹ì„ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ë¥¼ ì¶”ì¶œí•˜ëŠ” í˜ì‹ ì ì¸ ì ‘ê·¼ë²•ì— ëŒ€í•´ ì„¤ëª…í•©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ê¸°ì¡´ì˜ ì •ê·œì‹ ê¸°ë°˜ íŒŒì‹±ì´ë‚˜ deprecatedëœ AST
APIì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ ê°œë°œë˜ì—ˆìŠµë‹ˆë‹¤.

## ğŸ¯ Mock Environmentë€?

**Mock Environment**ëŠ” FreeMarker í…œí”Œë¦¿ì„ ì‹¤ì œë¡œ ì‹¤í–‰í•˜ë©´ì„œ, í…œí”Œë¦¿ì´ ì ‘ê·¼í•˜ë ¤ëŠ” ëª¨ë“  ë³€ìˆ˜ë¥¼ **ê°€ë¡œì±„ì„œ ê¸°ë¡**í•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤. ë§ˆì¹˜ "ìŠ¤íŒŒì´"ì²˜ëŸ¼ í…œí”Œë¦¿ì˜ ë³€ìˆ˜ ì ‘ê·¼ì„ ëª°ë˜ ê°ì‹œí•˜ëŠ”
ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.

### í•µì‹¬ ì•„ì´ë””ì–´

```java
// í…œí”Œë¦¿: ${company.name!"N/A"}
// ì¼ë°˜ì ì¸ ì‹¤í–‰: company.nameì´ ì—†ì–´ì„œ "N/A" ì¶œë ¥

// Mock Environment ì‹¤í–‰:
// 1. FreeMarkerê°€ company.nameì— ì ‘ê·¼ ì‹œë„
// 2. Mock ëª¨ë¸ì´ ì´ë¥¼ ê°ì§€í•˜ê³  "company.name" ê¸°ë¡
// 3. ë™ì‹œì— mock ê°’ì„ ë°˜í™˜í•´ì„œ ì‹¤í–‰ ê³„ì†
```

## ğŸ¤” ì™œ Mock Environmentê°€ í•„ìš”í•œê°€?

### ê¸°ì¡´ ë°©ì‹ë“¤ì˜ í•œê³„

#### 1. **ì •ê·œì‹ ê¸°ë°˜ íŒŒì‹±**

```javascript
// ë¬¸ì œì : ë³µì¡í•œ í‘œí˜„ì‹ ì²˜ë¦¬ ì–´ë ¤ì›€
$
{
    company.name
    !"ê¸°ë³¸ê°’ with spaces and \"quotes\""
}  // íŒŒì‹± ì‹¤íŒ¨
$
{
    user.profile?.avatar ? has_content
}  // ë³µì¡í•œ í‘œí˜„ì‹ ë†“ì¹¨
$
{
    items[0].price * quantity
}  // ì—°ì‚°ìê°€ í¬í•¨ëœ ê²½ìš°
```

#### 2. **FreeMarker AST ì ‘ê·¼**

```java
// ë¬¸ì œì : deprecated API, ë²„ì „ í˜¸í™˜ì„± ë¬¸ì œ
TemplateElement rootElement = template.getRootElement(); // âš ï¸ Deprecated
ParentParseNode parent = (ParentParseNode) element;      // âš ï¸ í´ë˜ìŠ¤ ì—†ìŒ
```

#### 3. **í…ìŠ¤íŠ¸ ë¶„ì„ì˜ ê·¼ë³¸ì  í•œê³„**

- ê¸°ë³¸ê°’ êµ¬ë¬¸ íŒŒì‹± ì˜¤ë¥˜
- ì¤‘ì²© ê´„í˜¸ ì²˜ë¦¬ ì‹¤íŒ¨
- ì¡°ê±´ë¶€ í‘œí˜„ì‹ ëˆ„ë½
- í•¨ìˆ˜ í˜¸ì¶œê³¼ ë³€ìˆ˜ êµ¬ë¶„ ì‹¤íŒ¨

### Mock Environmentì˜ í•´ê²°ì±…

âœ… **FreeMarker íŒŒì„œë¥¼ ê·¸ëŒ€ë¡œ í™œìš©** - 100% ì •í™•í•œ íŒŒì‹±  
âœ… **ëª¨ë“  ë²„ì „ í˜¸í™˜** - ì•ˆì •ì ì¸ ê³µê°œ APIë§Œ ì‚¬ìš©  
âœ… **ë³µì¡í•œ í‘œí˜„ì‹ ì™„ë²½ ì²˜ë¦¬** - FreeMarkerê°€ ì•Œì•„ì„œ íŒŒì‹±  
âœ… **ê¸°ë³¸ê°’ êµ¬ë¬¸ ìë™ ì²˜ë¦¬** - `${var!"default"}`ì—ì„œ ìë™ìœ¼ë¡œ `var` ì¶”ì¶œ

## ğŸ”§ ì‘ë™ ì›ë¦¬

### 1. Mock ë°ì´í„° ëª¨ë¸ ìƒì„±

```java
public class VariableCapturingModel implements TemplateHashModel {
    private final Set<String> accessedVariables = new LinkedHashSet<>();

    @Override
    public TemplateModel get(String key) throws TemplateModelException {
        // ğŸ¯ í•µì‹¬: ë³€ìˆ˜ ì ‘ê·¼ì„ ê¸°ë¡
        accessedVariables.add(key);

        // ì¤‘ì²© ì ‘ê·¼ì„ ìœ„í•´ ìƒˆë¡œìš´ Mock ëª¨ë¸ ë°˜í™˜
        return new NestedCapturingModel(key, accessedVariables);
    }
}
```

### 2. ì¤‘ì²© ë³€ìˆ˜ ì²˜ë¦¬

```java
public class NestedCapturingModel implements TemplateHashModel {
    private final String basePath;  // ì˜ˆ: "company"

    @Override
    public TemplateModel get(String key) throws TemplateModelException {
        String fullPath = basePath + "." + key;  // "company.name"
        accessedVariables.add(fullPath);

        // ë” ê¹Šì€ ì¤‘ì²©ì„ ìœ„í•´ ìƒˆë¡œìš´ ëª¨ë¸ ë°˜í™˜
        return new NestedCapturingModel(fullPath, accessedVariables);
    }
}
```

### 3. ë‹¤ì–‘í•œ íƒ€ì… ì§€ì›

```java
// Mock ëª¨ë¸ì´ ëª¨ë“  FreeMarker íƒ€ì…ì„ ì§€ì›
public class NestedCapturingModel implements
        TemplateHashModel,      // ${obj.property}
        TemplateScalarModel,    // ${str}
        TemplateSequenceModel,  // ${list[0]}
        TemplateBooleanModel,   // ${bool?then('yes', 'no')}
        TemplateNumberModel,    // ${num + 1}
        TemplateDateModel {     // ${date?string('yyyy-MM-dd')}

    // ê° íƒ€ì…ë³„ë¡œ ì ì ˆí•œ mock ê°’ ë°˜í™˜
    @Override
    public String getAsString() {
        return "mock_value";
    }

    @Override
    public boolean getAsBoolean() {
        return true;
    }

    @Override
    public Number getAsNumber() {
        return 0;
    }
}
```

## ğŸ“‹ ì‹¤í–‰ ê³¼ì • ì˜ˆì‹œ

### í…œí”Œë¦¿ ì˜ˆì‹œ

```freemarker
<!DOCTYPE html>
<html>
<head>
    <title>${documentType!"ì†¡ì¥"} - ${invoiceNumber!"N/A"}</title>
</head>
<body>
    <h1>${company.name!"Unknown Company"}</h1>
    <p>ì£¼ì†Œ: ${company.address!"ì£¼ì†Œ ì—†ìŒ"}</p>
    
    <#if client?? && client?is_hash>
        <div>í´ë¼ì´ì–¸íŠ¸: ${client.name!"Unknown Client"}</div>
        <div>ì—°ë½ì²˜: ${client.phone!"ì—°ë½ì²˜ ì—†ìŒ"}</div>
    </#if>
    
    <#list items as item>
        <div>${item.name!"Item"}: ${item.price!"0"}ì›</div>
    </#list>
</body>
</html>
```

### Mock Environment ì‹¤í–‰ ì¶”ì 

```java
// 1. FreeMarker í…œí”Œë¦¿ ì‹¤í–‰ ì‹œì‘
template.process(mockModel, writer);

// 2. ë³€ìˆ˜ ì ‘ê·¼ ì¶”ì  ê³¼ì •
$ {
    documentType !"ì†¡ì¥"
}           â†’ mockModel.

get("documentType") í˜¸ì¶œ â†’ "documentType"ê¸°ë¡

$ {
    invoiceNumber !"N/A"
}          â†’ mockModel.

get("invoiceNumber") í˜¸ì¶œ â†’ "invoiceNumber"ê¸°ë¡

$ {
    company.name !"Unknown"
}       â†’ mockModel.

get("company") í˜¸ì¶œ â†’ "company"ê¸°ë¡
                                â†’ company_mock.

get("name") í˜¸ì¶œ â†’ "company.name"ê¸°ë¡

$ {
    company.address !"ì£¼ì†Œ ì—†ìŒ"
}    â†’ company_mock.

get("address") í˜¸ì¶œ â†’ "company.address"ê¸°ë¡

// 3. ì¡°ê±´ë¬¸ì—ì„œì˜ ë³€ìˆ˜ ì ‘ê·¼
        <#if client??>                  â†’ mockModel.

get("client") í˜¸ì¶œ â†’ "client"ê¸°ë¡

$ {
    client.name !"Unknown"
}        â†’ client_mock.

get("name") í˜¸ì¶œ â†’ "client.name"ê¸°ë¡

$ {
    client.phone !"ì—°ë½ì²˜ ì—†ìŒ"
}     â†’ client_mock.

get("phone") í˜¸ì¶œ â†’ "client.phone"ê¸°ë¡

// 4. ë°˜ë³µë¬¸ì—ì„œì˜ ë³€ìˆ˜ ì ‘ê·¼
        <#
list items
as item>           â†’ mockModel.

get("items") í˜¸ì¶œ â†’ "items"ê¸°ë¡

$ {
    item.name !"Item"
}             â†’ item_mock.

get("name") í˜¸ì¶œ â†’ "item.name"

ê¸°ë¡(loop variable)

$ {
    item.price !"0"
}               â†’ item_mock.

get("price") í˜¸ì¶œ â†’ "item.price"ê¸°ë¡
```

### ìµœì¢… ìˆ˜ì§‘ëœ ë³€ìˆ˜ë“¤

```java
Set<String> capturedVariables = {
        "documentType",
        "invoiceNumber",
        "company",          // ë£¨íŠ¸ ê°ì²´
        "company.name",     // ì¤‘ì²© ì†ì„±
        "company.address",
        "client",
        "client.name",
        "client.phone",
        "items",            // ë°°ì—´/ë¦¬ìŠ¤íŠ¸
        "item.name",        // ë°˜ë³µë¬¸ ë‚´ ì ‘ê·¼
        "item.price"
}
```

## ğŸ”„ í•˜ì´ë¸Œë¦¬ë“œ ì ‘ê·¼ë²•: Mock + ì •ê·œì‹

Mock Environmentë§Œìœ¼ë¡œëŠ” 100% ì™„ë²½í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, **ì •êµí•œ ì •ê·œì‹ê³¼ ê²°í•©**í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

### ê²°í•© ë°©ì‹

```java
public TemplateVariableAnalysis analyzeTemplate(String templateName) {
    // 1. Mock Environmentë¡œ ë³€ìˆ˜ ì¶”ì¶œ
    Set<String> mockExtractedVars = extractVariablesUsingMockEnvironment(templateName);

    // 2. ì •ê·œì‹ìœ¼ë¡œ ì¶”ê°€ ë³€ìˆ˜ ì¶”ì¶œ
    Set<String> regexExtractedVars = extractVariablesUsingRegex(templateContent, analysis);

    // 3. ë‘ ê²°ê³¼ í•©ì¹˜ê¸°
    Set<String> allVariables = new LinkedHashSet<>();
    allVariables.addAll(mockExtractedVars);
    allVariables.addAll(regexExtractedVars);

    // 4. ê³„ì¸µ êµ¬ì¡° ìƒì„±
    buildHierarchicalStructure(allVariables, hierarchicalVariables);
}
```

### Mock Environmentì˜ ì¥ì 

- âœ… FreeMarker íŒŒì„œì˜ ì •í™•ì„±
- âœ… ë³µì¡í•œ í‘œí˜„ì‹ ì™„ë²½ ì²˜ë¦¬
- âœ… ê¸°ë³¸ê°’ êµ¬ë¬¸ ìë™ ì²˜ë¦¬

### ì •ê·œì‹ì˜ ë³´ì™„ ì—­í• 

- âœ… Mock ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ë¡œ ë†“ì¹œ ë³€ìˆ˜ í¬ì°©
- âœ… ë§¤í¬ë¡œ, í•¨ìˆ˜ ì •ì˜ ì¶”ì¶œ
- âœ… include/import ì§€ì‹œì–´ ì²˜ë¦¬

## ğŸ—ï¸ ê³„ì¸µ êµ¬ì¡° ìƒì„±

ìˆ˜ì§‘ëœ ë³€ìˆ˜ë“¤ì„ **ê³„ì¸µì  êµ¬ì¡°**ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

### ë³€ìˆ˜ ê²½ë¡œ â†’ ê³„ì¸µ êµ¬ì¡° ë³€í™˜

```java
// ì…ë ¥: Set<String> variables
[
        "company",
        "company.name",
        "company.address",
        "client.name",
        "client.phone",
        "items"
        ]

// ì¶œë ¥: Map<String, Object> hierarchicalVariables
        {
        "company":{
        "name":"",
        "address":""
        },
        "client":{
        "name":"",
        "phone":""
        },
        "items":[]
        }
```

### êµ¬ì¡° ìƒì„± ë¡œì§

```java
private void createHierarchicalPath(String varPath, Map<String, Object> hierarchicalVariables) {
    String[] parts = varPath.split("\\.");  // ["company", "name"]
    Map<String, Object> current = hierarchicalVariables;

    // ê²½ë¡œë¥¼ ë”°ë¼ ë‚´ë ¤ê°€ë©° êµ¬ì¡° ìƒì„±
    for (int i = 0; i < parts.length - 1; i++) {
        String part = parts[i];  // "company"

        if (!current.containsKey(part)) {
            current.put(part, new LinkedHashMap<String, Object>());
        }

        current = (Map<String, Object>) current.get(part);
    }

    // ë§ˆì§€ë§‰ ì†ì„± ì¶”ê°€
    String lastPart = parts[parts.length - 1];  // "name"
    current.put(lastPart, createDefaultValue(lastPart));
}
```

## âš¡ ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### Mock Environment ì‹¤í–‰ ë¹„ìš©

```java
// ì‹¤í–‰ ì‹œê°„ ì¸¡ì •
long startTime = System.currentTimeMillis();
template.

process(mockModel, writer);

long mockExecutionTime = System.currentTimeMillis() - startTime;

// ì¼ë°˜ì ìœ¼ë¡œ ì‹¤ì œ ë Œë”ë§ë³´ë‹¤ ë¹ ë¦„ (ì¶œë ¥ ì‘ì—… ì—†ìŒ)
// ë³µì¡í•œ í…œí”Œë¦¿: ~10-50ms
// ë‹¨ìˆœí•œ í…œí”Œë¦¿: ~1-5ms
```

### ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰

```java
// ë³€ìˆ˜ ì¶”ì ì„ ìœ„í•œ ë©”ëª¨ë¦¬ ì‚¬ìš©
Set<String> accessedVariables;  // ë³€ìˆ˜ ì´ë¦„ë“¤ë§Œ ì €ì¥ (ê°€ë²¼ì›€)
// 100ê°œ ë³€ìˆ˜ Ã— í‰ê·  20ê¸€ì = ~2KB

// Mock ëª¨ë¸ ì²´ì¸
NestedCapturingModel ê°ì²´ë“¤;   // ì¤‘ì²© ê¹Šì´ë§Œí¼ ìƒì„±
// ì¼ë°˜ì ìœ¼ë¡œ 5-10ê°œ ìˆ˜ì¤€ (ë¬´ê±°ìš°ì§€ ì•ŠìŒ)
```

## ğŸ›¡ï¸ ì•ˆì „ì„±ê³¼ ì˜¤ë¥˜ ì²˜ë¦¬

### í…œí”Œë¦¿ ì‹¤í–‰ ì˜¤ë¥˜ ì²˜ë¦¬

```java
try{
        template.process(mockModel, writer);
}catch(
Exception e){
        // ì˜ˆìƒë˜ëŠ” ìƒí™©: ë³€ìˆ˜ê°€ ì—†ì–´ì„œ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜
        log.

trace("Expected error during mock processing: {}",e.getMessage());
        // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ì´ë¯¸ ìˆ˜ì§‘ëœ ë³€ìˆ˜ë“¤ì€ ìœ íš¨
        }
```

### Fallback ë©”ì»¤ë‹ˆì¦˜

```java
// Mock Environment ì‹¤íŒ¨ ì‹œ ì •ê·œì‹ìœ¼ë¡œ fallback
if(mockExtractedVars.isEmpty()){
        log.

warn("Mock environment extraction failed, using regex fallback");
// ì •ê·œì‹ ê¸°ë°˜ ì¶”ì¶œë¡œ ëŒ€ì²´
}
```

### ìˆœí™˜ ì°¸ì¡° ë°©ì§€

```java
// ê³„ì¸µ êµ¬ì¡° ìƒì„± ì‹œ ê¹Šì´ ì œí•œ
private String convertToJson(Object obj, int depth) {
    if (depth > 10) return "\"...\"";  // ìˆœí™˜ ì°¸ì¡° ë°©ì§€
    // ...
}
```

## ğŸ¯ ì‹¤ì œ ì‚¬ìš© ì‚¬ë¡€

### invoice.ftl ë¶„ì„ ê²°ê³¼

```json
{
  "templateId": "invoice.ftl",
  "hierarchicalVariables": {
    "documentType": "",
    "invoiceNumber": "",
    "company": {
      "name": "",
      "address": "",
      "phone": "",
      "email": "",
      "website": "",
      "businessNumber": ""
    },
    "client": {
      "name": "",
      "address": "",
      "contactPerson": "",
      "phone": "",
      "email": "",
      "businessNumber": ""
    },
    "issueDate": "",
    "dueDate": "",
    "salesperson": "",
    "projectName": "",
    "referenceNumber": "",
    "poNumber": "",
    "paymentTerms": "",
    "items": [],
    "discount": "",
    "discountType": "",
    "discountAmount": "",
    "taxRate": "",
    "taxAmount": "",
    "totalAmount": "",
    "paymentInfo": "",
    "notes": ""
  },
  "assignedVariables": [
    "subtotal",
    "itemQuantity",
    "itemRate",
    "itemTotal"
  ],
  "loopVariables": [
    "item"
  ],
  "templateValid": true
}
```

### ë³µì¡í•œ í‘œí˜„ì‹ ì²˜ë¦¬ ì˜ˆì‹œ

```freemarker
<!-- ì´ëŸ° ë³µì¡í•œ í‘œí˜„ì‹ë“¤ë„ ì™„ë²½ ì²˜ë¦¬ -->
${user.profile?.avatar?has_content?then(user.profile.avatar, '/default-avatar.png')}
${items?filter(item -> item.active)?map(item -> item.name)?join(', ')}
${company.settings["invoice.template"]!"default"}
```

## ğŸ”® í–¥í›„ ê°œì„  ë°©í–¥

### 1. ìºì‹± ë©”ì»¤ë‹ˆì¦˜

```java
// í…œí”Œë¦¿ ë¶„ì„ ê²°ê³¼ ìºì‹±
private final Map<String, TemplateVariableAnalysis> analysisCache = new ConcurrentHashMap<>();

public TemplateVariableAnalysis analyzeTemplate(String templateName) {
    return analysisCache.computeIfAbsent(templateName, this::doAnalyzeTemplate);
}
```

### 2. ë³‘ë ¬ ì²˜ë¦¬

```java
// ì—¬ëŸ¬ í…œí”Œë¦¿ ë™ì‹œ ë¶„ì„
public Map<String, TemplateVariableAnalysis> analyzeTemplates(List<String> templateNames) {
    return templateNames.parallelStream()
            .collect(Collectors.toConcurrentMap(
                    Function.identity(),
                    this::analyzeTemplate
            ));
}
```

### 3. íƒ€ì… ì¶”ë¡ 

```java
// ë³€ìˆ˜ íƒ€ì… ì¶”ë¡  ê¸°ëŠ¥
public class SmartVariableAnalysis extends TemplateVariableAnalysis {
    private Map<String, VariableType> variableTypes;

    // ${items?size} â†’ itemsëŠ” Collection íƒ€ì…
    // ${user.age + 1} â†’ user.ageëŠ” Number íƒ€ì…
}
```

## ğŸ“š ê²°ë¡ 

Mock Environment ë°©ì‹ì€ FreeMarker í…œí”Œë¦¿ ë³€ìˆ˜ ì¶”ì¶œì˜ **ê²Œì„ ì²´ì¸ì €**ì…ë‹ˆë‹¤:

### ğŸ‰ í˜ì‹ ì ì¸ ì ë“¤

1. **FreeMarker íŒŒì„œ í™œìš©**: ì •ê·œì‹ ëŒ€ì‹  ì‹¤ì œ íŒŒì„œ ì‚¬ìš©
2. **ì‹¤í–‰ ì¤‘ ê°ì‹œ**: í…œí”Œë¦¿ì„ ì†ì—¬ì„œ ë³€ìˆ˜ ì ‘ê·¼ ê¸°ë¡
3. **ì™„ë²½í•œ ì •í™•ë„**: ë³µì¡í•œ í‘œí˜„ì‹ë„ 100% ì²˜ë¦¬
4. **ì•ˆì •ì ì¸ API**: deprecated ì—†ëŠ” ê³µê°œ APIë§Œ ì‚¬ìš©

### ğŸš€ ì‹¤ìš©ì  ê°€ì¹˜

- **ê°œë°œ ìƒì‚°ì„± í–¥ìƒ**: ì •í™•í•œ ë³€ìˆ˜ ì¶”ì¶œë¡œ í…œí”Œë¦¿ ì‘ì—… íš¨ìœ¨ì„± ì¦ëŒ€
- **ìœ ì§€ë³´ìˆ˜ì„±**: ì•ˆì •ì ì¸ API ì‚¬ìš©ìœ¼ë¡œ ë²„ì „ í˜¸í™˜ì„± ë³´ì¥
- **í™•ì¥ì„±**: ìƒˆë¡œìš´ FreeMarker ê¸°ëŠ¥ë„ ìë™ìœ¼ë¡œ ì§€ì›

ì´ ë°©ì‹ì€ ë‹¨ìˆœíˆ ë³€ìˆ˜ë¥¼ ì¶”ì¶œí•˜ëŠ” ê²ƒì„ ë„˜ì–´ì„œ, **FreeMarkerì˜ ì§„ì •í•œ íŒŒì›Œë¥¼ í™œìš©**í•˜ëŠ” í˜ì‹ ì ì¸ ì ‘ê·¼ë²•ì…ë‹ˆë‹¤. ğŸ¯